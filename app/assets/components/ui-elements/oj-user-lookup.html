<dom-module id="oj-user-lookup">
  <style>
      :host {
          display: inline-block;
          position: relative;
      }

      input {
          font-size:      14px;
          padding:        0 4px;
          vertical-align: top;
      }

      #suggestions {
        display:   none;
        position:  absolute;
        z-index:   100;
        min-width: 250px;
        top:       20px;
      }
      #suggestions paper-menu {
          margin: 0;
      }

      paper-item {
        box-sizing: border-box;
        padding:    5px 10px;
        background-color: #f8f8f8;
        color:black;
        border-bottom: 1px solid black;
        cursor: pointer;
      }
      paper-item:hover {
          background-color: #ffffff;
      }
      paper-item:last-child {
          border-bottom: none;
      }
      paper-item.selected {
          font-weight: normal;
      }

      /* Only show the drop down when the edit is focused */
      input:focus + #suggestions, #suggestions:active, #suggestions:focus {
          display: block;
      }

    </style>
  <template>

    <input id="input" placeholder="{{placeholder}}" value="{{search::input}}">

    <iron-dropdown id="suggestions" position-target="{{$.input}}" vertical-align="bottom" autoclosedisabled="true" autofocusdisabled="true">
        <paper-menu>
          <template is="dom-repeat" items="{{suggestions}}" as="suggestion">
            <paper-item on-tap="selectUser">{{suggestion.name}}</paper-item>
          </template>
        </paper-menu>
    </iron-dropdown>

    <json-request id="lookUpSearch" method="get" on-success="lookupSuccess"></json-request>
  </template>
  <script>
    Polymer({
      is: 'oj-user-lookup',
      properties: {
        placeholder: { notify: true },
        search: { observer: 'searchChanged' }
      },
      created: function () {
        this.suggestions = [];
      },
      searchChanged: function () {
        this.debounce('user_search', function () {
          if (this.search.length > 2) {
            this.$.lookUpSearch.url = '/api/user/lookup?guess=' + encodeURIComponent(this.search);
            this.$.lookUpSearch.go();
          }
        }, 300);
      },
      lookupSuccess: function (event, suggestions) {
        this.suggestions = this.fire('filter-suggestions', suggestions).result || suggestions;
        if (this.suggestions.length) {
          this.async(function () {
            this.$.suggestions.opened = true;
            this.$.suggestions.discoverDimensions();
            this.$.suggestions.resetTargetDimensions();
          });
        }
      },
      selectUser: function (event, detail, sender) {
        var user = event.target.templateInstance.model.suggestion;
        this.set('$.suggestions.opened', false);
        this.search = '';
        this.suggestions = [];
        this.fire('user-selected', user);
      }
    });
  </script>
</dom-module>
